<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ê¶ë‚¨ì§€ ìƒíƒœì§€ë„ (ëª¨ë°”ì¼ ìš°ì„ )</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.css"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.css"/>
  <style>
    html, body { height:100%; margin:0; }
    body { font-family:system-ui, sans-serif; }
    #map { width:100%; height:100%; }
    #app { display:grid; grid-template-columns:300px 1fr; height:100%; }
    aside { border-right:1px solid #ddd; padding:12px; overflow:auto; background:#333; }
    .brand { font-weight:700; font-size:18px; margin-bottom:8px; color:#fff; }
    .legend { display:flex; align-items:center; gap:6px; margin:4px 0; color:#fff; }
    .chip { width:14px; height:14px; border-radius:4px; }
    .chip.birds{background:#2563eb;} .chip.plants{background:#059669;} .chip.insects{background:#d97706;}
    .panel{ background:#444; border:1px solid #555; border-radius:8px; padding:8px; margin:8px 0; color:#fff; }
    .fab{ position:fixed; right:12px; bottom:12px; z-index:1000; padding:8px 14px; border-radius:999px; background:#fff; border:1px solid #ddd; box-shadow:0 2px 8px #0002; }
    #sheet{ position:fixed; left:0; right:0; bottom:0; background:#fff; border-top-left-radius:16px; border-top-right-radius:16px; transform:translateY(100%); transition:.3s; z-index:999; max-height:70%; overflow:auto; }
    #sheet.open{ transform:translateY(0); }
    #grab{ width:40px; height:4px; background:#ccc; border-radius:2px; margin:10px auto; }
    @media(max-width:880px){ #app{ grid-template-columns:1fr; } aside{display:none;} .fab{display:block;} } 
    @media(min-width:881px){ .fab,#sheet{display:none;} }
  </style>
</head>
<body>
<div id="app">
  <aside>
    <div class="brand">ê¶ë‚¨ì§€ ìƒíƒœì§€ë„</div>
    <div class="panel">
      <strong>ë ˆì´ì–´</strong><br>
      <label><input type="checkbox" id="birdsToggle" checked> ê³¤ì¶© ì™¸ ë™ë¬¼</label><br>
      <label><input type="checkbox" id="plantsToggle" checked> ì‹ë¬¼</label><br>
      <label><input type="checkbox" id="insectsToggle" checked> ê³¤ì¶©</label><br>
      <label><input type="checkbox" id="heatToggle"> íˆíŠ¸ë§µ</label>
    </div>
    <div class="panel">
      <strong>ë²”ë¡€</strong>
      <div class="legend"><span class="chip birds"></span>ê³¤ì¶© ì™¸ ë™ë¬¼</div>
      <div class="legend"><span class="chip plants"></span>ì‹ë¬¼</div>
      <div class="legend"><span class="chip insects"></span>ê³¤ì¶©</div>
    </div>
  </aside>
  <main><div id="map"></div></main>
</div>
<button class="fab" id="openSheet">ë ˆì´ì–´</button>
<div id="sheet"><div id="grab"></div>
  <div style="padding:10px 16px">
    <strong>ë ˆì´ì–´</strong><br>
    <label><input type="checkbox" id="mb_birds" checked> ê³¤ì¶© ì™¸ ë™ë¬¼</label><br>
    <label><input type="checkbox" id="mb_plants" checked> ì‹ë¬¼</label><br>
    <label><input type="checkbox" id="mb_insects" checked> ê³¤ì¶©</label><br>
    <label><input type="checkbox" id="mb_heat"> íˆíŠ¸ë§µ</label>
    <hr>
    <strong>ë²”ë¡€</strong>
    <div class="legend"><span class="chip birds"></span>ê³¤ì¶© ì™¸ ë™ë¬¼</div>
    <div class="legend"><span class="chip plants"></span>ì‹ë¬¼</div>
    <div class="legend"><span class="chip insects"></span>ê³¤ì¶©</div>
  </div>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/leaflet.heat/dist/leaflet-heat.js"></script>
<script src="https://unpkg.com/leaflet-control-geocoder/dist/Control.Geocoder.js"></script>
<script src="https://unpkg.com/leaflet.locatecontrol/dist/L.Control.Locate.min.js"></script>
<script>
// 0) ì§€ë„ & ë² ì´ìŠ¤ë ˆì´ì–´
const map = L.map('map').setView([36.269681,126.912143],16);
const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:19, attribution:'&copy; OpenStreetMap'}).addTo(map);
const esriSat = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}',{maxZoom:19, attribution:'Tiles &copy; Esri'});
L.control.layers({"ì¼ë°˜(OSM, ê¸°ë³¸)":osm,"ìœ„ì„±(Esri)":esriSat},{},{collapsed:true}).addTo(map);

// 1) í°ìƒ‰ ë°°ê²½ ë§ˆìŠ¤í¬ (ë°˜ê²½ 340m ì› ë‚´ë¶€ë§Œ ë³´ì´ê²Œ)
map.createPane('maskPane');
map.getPane('maskPane').style.zIndex = 650; // íƒ€ì¼/ë²¡í„° ìœ„ì— ë®ìŒ
map.getPane('maskPane').style.pointerEvents = 'none';
function toRad(d){return d*Math.PI/180;} function toDeg(r){return r*180/Math.PI;}
function circleCoords(lat,lng,r,steps=128){const R=6371000,d=r/R,lat1=toRad(lat),lon1=toRad(lng);const coords=[];for(let i=0;i<steps;i++){const brng=toRad(i/steps*360);const lat2=Math.asin(Math.sin(lat1)*Math.cos(d)+Math.cos(lat1)*Math.sin(d)*Math.cos(brng));const lon2=lon1+Math.atan2(Math.sin(brng)*Math.sin(d)*Math.cos(lat1),Math.cos(d)-Math.sin(lat1)*Math.sin(lat2));coords.push([toDeg(lat2),toDeg(lon2)]);}return coords;}
const focus={lat:36.269681,lng:126.912143,radiusM:340};
const ringCoords = circleCoords(focus.lat, focus.lng, focus.radiusM, 128);
const world=[[-89.9,-179.9],[-89.9,179.9],[89.9,179.9],[89.9,-179.9]];
L.polygon([world, ringCoords.slice().reverse()], {pane:'maskPane', stroke:false, fillColor:'#fff', fillOpacity:1}).addTo(map);
L.polygon(ringCoords,{color:'#10b981',weight:2,dashArray:'5,5',fill:false}).addTo(map);

// 2) ì•„ì´ì½˜/ê·¸ë£¹
const icons={
  birds:L.divIcon({html:'<div style="background:#2563eb;color:#fff;padding:1px 3px;border-radius:6px">ğŸ•Šï¸</div>',iconSize:[14,14],iconAnchor:[7,7]}),
  plants:L.divIcon({html:'<div style="background:#059669;color:#fff;padding:1px 3px;border-radius:6px">ğŸŒ¿</div>',iconSize:[14,14],iconAnchor:[7,7]}),
  insects:L.divIcon({html:'<div style="background:#d97706;color:#fff;padding:1px 3px;border-radius:6px">ğŸ›</div>',iconSize:[14,14],iconAnchor:[7,7]})
};
const groups={birds:L.layerGroup().addTo(map),plants:L.layerGroup().addTo(map),insects:L.layerGroup().addTo(map)};

// 3) ë°ì´í„° (ìƒ˜í”Œ + ì‚¬ìš©ì ìš”ì²­ ë„¤ë°œë‚˜ë¹„)
const points=[
 {cat:'birds',name:'ì²­ê°œêµ¬ë¦¬',lat:36.269611,lon:126.911023,
  desc: 'ì•„ì£¼ ê·€ì—¬ìš´ ê°œêµ¬ë¦¬',
  ing:'./Images/b1.jpg' },
 {cat:'plants',name:'ì—°ê½ƒ êµ°ë½',lat:36.2699,lon:126.9130},
 {cat:'insects',name:'ë„¤ë°œë‚˜ë¹„ (<i>Polygonia c-aureum</i>)', lat:36.269439, lon:126.9137465,
  desc:'ì´ ë‚˜ë¹„ëŠ” ë„¤ë°œë‚˜ë¹„ë¡œ ì£¼í™©ìƒ‰ ì¥ê°€ íŒŒë¨¹ì€ë“¯í•œ ë‚ ê°œê°€ íŠ¹ì§•ì´ë‹¤.',
  img:'./Images/bf.jpg'},
  {cat:'insects',name:'ë‚¨ë°©ë¶€ì „ë‚˜ë¹„ (<i>Pseudozizeeria maha</i>)', lat:36.2691517, lon:126.9136577,
  desc:'ê°€ì¥ í”í•œ ë¶€ì „ë‚˜ë¹„ë‹¤.',
  img:'./Images/bf2.jpg'}
];

points.forEach(p=>{
  const descHtml = p.desc?`<div style="margin:6px 0;color:#374151">${p.desc}</div>`:'';
  const imgHtml = p.img?`<img src="${p.img}" alt="${p.name}" style="width:100%;height:auto;border-radius:8px">`:'';
  const html = `<div style="min-width:220px;max-width:280px;line-height:1.35">
    <div style="font-weight:700;margin-bottom:4px">${p.name||''}</div>
    ${descHtml}${imgHtml}
  </div>`;
  const icon = icons[p.cat] || icons.plants;
  L.marker([p.lat,p.lon],{icon}).bindPopup(html).addTo(groups[p.cat]);
});

// 4) íˆíŠ¸ë§µ
const heat = L.heatLayer(points.map(p=>[p.lat,p.lon, (p.cat==='birds'?0.6:(p.cat==='insects'?0.8:0.5)) ]),{radius:25,blur:15});

// 5) í† ê¸€ ë°”ì¸ë”© (ë°ìŠ¤í¬í†±/ëª¨ë°”ì¼)
function bind(id,key){ const el=document.getElementById(id); if(!el) return; el.addEventListener('change',e=>{ e.target.checked?groups[key].addTo(map):map.removeLayer(groups[key]); }); }
bind('birdsToggle','birds'); bind('plantsToggle','plants'); bind('insectsToggle','insects');
const ht=document.getElementById('heatToggle'); if(ht){ ht.addEventListener('change',e=>{ e.target.checked?heat.addTo(map):map.removeLayer(heat); }); }
const sheet=document.getElementById('sheet'); document.getElementById('openSheet').onclick=()=>sheet.classList.add('open'); document.getElementById('grab').onclick=()=>sheet.classList.remove('open');
bind('mb_birds','birds'); bind('mb_plants','plants'); bind('mb_insects','insects');
const mbht=document.getElementById('mb_heat'); if(mbht){ mbht.addEventListener('change',e=>{ e.target.checked?heat.addTo(map):map.removeLayer(heat); }); }
</script>
</body>
</html>
